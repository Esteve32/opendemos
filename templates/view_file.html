{% extends "base.html" %}

{% block title %}View {{ filename }} - Gemini HTML Manager{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('list_files') }}">Files</a></li>
                <li class="breadcrumb-item active">{{ filename }}</li>
            </ol>
        </nav>
        
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h1 class="display-6 mb-2">
                    <i class="bi bi-file-earmark-code text-primary"></i> {{ filename }}
                </h1>
                {% if metadata and metadata.title %}
                    <p class="lead text-muted">{{ metadata.title }}</p>
                {% endif %}
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-success" onclick="uploadToDrive('{{ metadata.path }}', '{{ filename }}', false)">
                    <i class="bi bi-cloud-upload"></i> Upload to Drive
                </button>
                <button type="button" class="btn btn-info" onclick="uploadToDrive('{{ metadata.path }}', '{{ filename }}', true)">
                    <i class="bi bi-file-text"></i> Convert to Docs
                </button>
                <a href="{{ url_for('download_file', filename=filename) }}" class="btn btn-outline-secondary">
                    <i class="bi bi-download"></i> Download
                </a>
            </div>
        </div>
    </div>
</div>

{% if metadata %}
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle"></i> File Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-4">Filename:</dt>
                            <dd class="col-sm-8">{{ metadata.filename }}</dd>
                            
                            <dt class="col-sm-4">Size:</dt>
                            <dd class="col-sm-8">{{ "%.2f"|format(metadata.size_mb) }} MB ({{ metadata.size_bytes:,}} bytes)</dd>
                            
                            <dt class="col-sm-4">Created:</dt>
                            <dd class="col-sm-8">{{ metadata.created_time[:19] }}</dd>
                            
                            <dt class="col-sm-4">Modified:</dt>
                            <dd class="col-sm-8">{{ metadata.modified_time[:19] }}</dd>
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-4">Word Count:</dt>
                            <dd class="col-sm-8">{{ metadata.word_count:,}} words</dd>
                            
                            <dt class="col-sm-4">Has Images:</dt>
                            <dd class="col-sm-8">
                                {% if metadata.has_images %}
                                    <i class="bi bi-check-circle text-success"></i> Yes
                                {% else %}
                                    <i class="bi bi-x-circle text-muted"></i> No
                                {% endif %}
                            </dd>
                            
                            <dt class="col-sm-4">Has Links:</dt>
                            <dd class="col-sm-8">
                                {% if metadata.has_links %}
                                    <i class="bi bi-check-circle text-success"></i> Yes
                                {% else %}
                                    <i class="bi bi-x-circle text-muted"></i> No
                                {% endif %}
                            </dd>
                            
                            <dt class="col-sm-4">Source:</dt>
                            <dd class="col-sm-8">
                                {% if metadata.is_gemini_canvas %}
                                    <span class="badge gemini-badge">Gemini Canvas</span>
                                {% else %}
                                    <span class="badge bg-secondary">Other</span>
                                {% endif %}
                            </dd>
                        </dl>
                    </div>
                </div>
                
                {% if metadata.description %}
                <div class="mt-3">
                    <strong>Description:</strong>
                    <p class="text-muted mt-1">{{ metadata.description }}</p>
                </div>
                {% endif %}
                
                <div class="mt-3">
                    <small class="text-muted">
                        <strong>Checksum:</strong> {{ metadata.checksum }}
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-share"></i> Sharing Options
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-success" onclick="uploadToDrive('{{ metadata.path }}', '{{ filename }}', false)">
                        <i class="bi bi-cloud-upload"></i> Upload as HTML
                    </button>
                    <button type="button" class="btn btn-info" onclick="uploadToDrive('{{ metadata.path }}', '{{ filename }}', true)">
                        <i class="bi bi-file-text"></i> Convert to Google Docs
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="copyLocalPath()">
                        <i class="bi bi-link"></i> Copy File Path
                    </button>
                    <a href="{{ url_for('download_file', filename=filename) }}" class="btn btn-outline-secondary">
                        <i class="bi bi-download"></i> Download File
                    </a>
                </div>
                
                <hr>
                
                <h6>Export Benefits:</h6>
                <ul class="list-unstyled small">
                    <li><i class="bi bi-check text-success"></i> Easy sharing with colleagues</li>
                    <li><i class="bi bi-check text-success"></i> Collaborative editing in Google Docs</li>
                    <li><i class="bi bi-check text-success"></i> Version control and comments</li>
                    <li><i class="bi bi-check text-success"></i> Access from any device</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- HTML Preview -->
<div class="row">
    <div class="col">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-eye"></i> HTML Preview
                </h5>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-primary active" onclick="showPreview()">
                        <i class="bi bi-eye"></i> Preview
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="showSource()">
                        <i class="bi bi-code"></i> Source
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="preview-container" style="min-height: 400px;">
                    <iframe id="html-preview" 
                            style="width: 100%; height: 500px; border: 1px solid #dee2e6; border-radius: 0.375rem;"
                            srcdoc="{{ content|e }}">
                    </iframe>
                </div>
                
                <div id="source-container" style="display: none;">
                    <pre><code class="language-html" style="max-height: 500px; overflow-y: auto;">{{ content|e }}</code></pre>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div class="modal fade" id="progressModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Processing...</h5>
            </div>
            <div class="modal-body">
                <div class="progress mb-3">
                    <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%">0%</div>
                </div>
                <div id="progressText">Starting...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">

<script>
function showProgress(title) {
    document.querySelector('#progressModal .modal-title').textContent = title;
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('progressBar').textContent = '0%';
    document.getElementById('progressText').textContent = 'Starting...';
    
    const modal = new bootstrap.Modal(document.getElementById('progressModal'));
    modal.show();
    return modal;
}

function updateProgress(percent, text) {
    document.getElementById('progressBar').style.width = percent + '%';
    document.getElementById('progressBar').textContent = Math.round(percent) + '%';
    document.getElementById('progressText').textContent = text;
}

function uploadToDrive(filePath, filename, convert = false) {
    const action = convert ? 'Converting and uploading' : 'Uploading';
    const modal = showProgress(`${action} to Google Drive`);
    updateProgress(25, `${action} ${filename}...`);
    
    fetch('/api/upload_to_drive', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            file_path: filePath,
            title: filename,
            convert: convert
        })
    })
    .then(response => response.json())
    .then(data => {
        modal.hide();
        if (data.success) {
            const fileType = convert ? 'Google Doc' : 'HTML file';
            const message = `Successfully uploaded ${filename} as ${fileType}!\n\nView at: ${data.link}`;
            
            // Show success with option to view
            if (confirm(message + '\n\nOpen the file now?')) {
                window.open(data.link, '_blank');
            }
        } else {
            alert(`Upload failed: ${data.error}`);
        }
    })
    .catch(error => {
        modal.hide();
        alert(`Upload failed: ${error}`);
    });
}

function showPreview() {
    document.getElementById('preview-container').style.display = 'block';
    document.getElementById('source-container').style.display = 'none';
    
    // Update button states
    document.querySelector('button[onclick="showPreview()"]').classList.add('active');
    document.querySelector('button[onclick="showSource()"]').classList.remove('active');
}

function showSource() {
    document.getElementById('preview-container').style.display = 'none';
    document.getElementById('source-container').style.display = 'block';
    
    // Update button states
    document.querySelector('button[onclick="showPreview()"]').classList.remove('active');
    document.querySelector('button[onclick="showSource()"]').classList.add('active');
    
    // Highlight syntax
    Prism.highlightAll();
}

function copyLocalPath() {
    const path = '{{ metadata.path }}';
    navigator.clipboard.writeText(path).then(function() {
        // Show toast notification
        const toast = document.createElement('div');
        toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed';
        toast.style.top = '20px';
        toast.style.right = '20px';
        toast.style.zIndex = '9999';
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-check-circle"></i> File path copied to clipboard!
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        document.body.appendChild(toast);
        const toastBootstrap = new bootstrap.Toast(toast);
        toastBootstrap.show();
        
        toast.addEventListener('hidden.bs.toast', function() {
            document.body.removeChild(toast);
        });
    }, function(err) {
        alert('Failed to copy path: ' + err);
    });
}

// Make iframe responsive
function resizeIframe() {
    const iframe = document.getElementById('html-preview');
    try {
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        const height = Math.max(400, iframeDoc.body.scrollHeight + 20);
        iframe.style.height = height + 'px';
    } catch (e) {
        // Cross-origin restrictions or other issues
        iframe.style.height = '500px';
    }
}

// Try to resize iframe after load
document.getElementById('html-preview').addEventListener('load', resizeIframe);
</script>
{% endblock %}